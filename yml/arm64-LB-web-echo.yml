version: "3"

networks:
  net-int:
    ipam:
      config:
        - subnet: 172.21.1.0/24
  net-lan:
    ipam:
      config:
        - subnet: 172.21.2.0/24

services:
  web:
    image: rprustagi/arm64-ub22-host
    hostname: web
    networks:
      net-lan:
    expose: 
      - "80"
    command: bash -c "apachectl start 
                     && tail -f /dev/null
                     "

  echoserver:
    image: rprustagi/arm64-tcp-echo-server
    hostname: echoserver
    environment: 
      - ECHO_PORT=5555 # Internal port for echo server
    networks:
      net-lan:

  Loadbalancer:
    image: rprustagi/arm64-nginx-lb
    networks:
      net-lan:
        ipv4_address: 172.21.2.254
      net-int:
        ipv4_address: 172.21.1.254
    volumes:
      - ./nginx_lb_web_echo.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - web
      - echoserver
    ports:
      - "80:80"
      - "9000:9000"
    command: bash -c "nginx 
                     && tail -f /dev/null
                     "

